# План реализации Telegram-бота FindOrigin

## Этап 1: Инициализация проекта ✅

- [x] Создать Next.js проект с App Router
- [x] Настроить TypeScript
- [x] Создать структуру папок
- [x] Настроить переменные окружения (`.env.local`)
  - `TELEGRAM_BOT_TOKEN` — токен бота
  - `OPENAI_API_KEY` — ключ OpenAI API
  - `SERPER_API_KEY` — ключ для поиска (Google Serper API)
  - `ENABLE_AI_ANALYSIS` — флаг включения AI-анализа

## Этап 2: Webhook для Telegram ✅

- [x] Создать API route: `app/api/webhook/route.ts`
- [x] Реализовать обработку POST-запросов от Telegram
- [x] Извлекать `chat.id` и `text` из `update.message`
- [x] Возвращать `200 OK` немедленно
- [x] Создать утилиту для отправки сообщений через `sendMessage`

## Этап 3: Обработка входящих данных ✅

- [x] Определить тип входных данных (текст или ссылка)
- [x] Создать парсер для ссылок на Telegram-посты (`t.me/...`)
- [x] Реализовать извлечение текста из Telegram-постов
- [x] Валидация и очистка текста

## Этап 4: Извлечение ключевых данных ✅

- [x] Создать модуль анализа текста
- [x] Выделение ключевых утверждений
- [x] Извлечение сущностей:
  - даты
  - числа
  - имена
  - ссылки
- [x] Формирование поисковых запросов

## Этап 5: Поиск источников ✅

- [x] Интегрировать API для веб-поиска (Serper API)
- [x] Реализовать поиск по сформированным запросам
- [x] Фильтрация результатов по типу источника:
  - официальные сайты
  - новостные порталы
  - блоги
  - научные публикации
- [x] Сбор метаданных найденных страниц

## Этап 6: AI-анализ и сравнение

- [ ] Создать модуль `lib/ai.ts`
- [ ] Интегрировать OpenAI API
- [ ] Создать промпт для семантического сравнения
- [ ] Сравнить смысл исходного текста с найденными источниками
- [ ] Рассчитать оценку уверенности (0–100%)
- [ ] Ранжировать источники по релевантности

## Этап 7: Формирование ответа ✅

- [x] Создать шаблон ответа пользователю
- [x] Форматировать список источников (до 5 ссылок)
- [x] Показывать извлечённые данные
- [x] Обработка случаев когда источники не найдены

## Этап 8: Деплой на Vercel

- [ ] Настроить проект на Vercel
- [ ] Добавить переменные окружения в Vercel
- [ ] Задеплоить проект
- [ ] Зарегистрировать webhook в Telegram:
  ```powershell
  Invoke-RestMethod -Uri "https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://<APP>.vercel.app/api/webhook"
  ```

## Этап 9: Тестирование и отладка

- [ ] Тестирование с различными типами входных данных
- [ ] Обработка ошибок и edge-cases
- [ ] Логирование для отладки
- [ ] Оптимизация времени ответа

---

## Структура проекта

```
FindOrigin/
├── app/
│   ├── api/
│   │   └── webhook/
│   │       └── route.ts        # Telegram webhook handler
│   ├── layout.tsx
│   └── page.tsx
├── lib/
│   ├── telegram.ts             # Telegram API утилиты
│   ├── parser.ts               # Парсинг текста и ссылок
│   ├── extractor.ts            # Извлечение сущностей
│   └── search.ts               # Поиск в интернете
├── types/
│   └── index.ts                # TypeScript типы
├── .env.local                  # Переменные окружения
├── PROJECT.md                  # Спецификация
├── PLAN.md                     # План реализации
└── package.json
```

## Переменные окружения

| Переменная | Описание | Обязательно |
|------------|----------|-------------|
| `TELEGRAM_BOT_TOKEN` | Токен от @BotFather | Да |
| `SERPER_API_KEY` | Ключ Serper API для поиска | Нет* |

*Без ключа используется заглушка с примерами результатов

## Зависимости

```json
{
  "dependencies": {
    "next": "^14.2.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "openai": "^4.28.0"
  }
}
```
