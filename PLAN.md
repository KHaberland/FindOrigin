# План реализации Telegram-бота FindOrigin

## Этап 1: Инициализация проекта ✅

- [x] Создать Next.js проект с App Router
- [x] Настроить TypeScript
- [x] Создать структуру папок
- [x] Настроить переменные окружения (`.env.local`)

## Этап 2: Webhook для Telegram ✅

- [x] Создать API route: `app/api/webhook/route.ts`
- [x] Реализовать обработку POST-запросов от Telegram
- [x] Извлекать `chat.id` и `text` из `update.message`
- [x] Возвращать `200 OK` немедленно
- [x] Создать утилиту для отправки сообщений через `sendMessage`

## Этап 3: Обработка входящих данных ✅

- [x] Определить тип входных данных (текст или ссылка)
- [x] Создать парсер для ссылок на Telegram-посты (`t.me/...`)
- [x] Реализовать извлечение текста из Telegram-постов
- [x] Валидация и очистка текста

## Этап 4: AI-генерация поисковых запросов ✅

- [x] Интегрировать OpenAI GPT-4o-mini
- [x] AI генерирует 2-3 поисковых запроса из текста
- [x] Fallback на первые 100 символов текста

## Этап 5: Поиск источников ✅

- [x] Интегрировать Google Custom Search API
- [x] Fallback на DuckDuckGo
- [x] Поиск по нескольким запросам
- [x] Удаление дубликатов

## Этап 6: AI-анализ и сравнение ✅

- [x] Создать модуль `lib/ai.ts`
- [x] Интегрировать OpenAI GPT-4o-mini
- [x] Создать промпт для семантического сравнения
- [x] Сравнить смысл исходного текста с найденными источниками
- [x] Рассчитать оценку уверенности (0–100%)
- [x] Ранжировать источники по релевантности

## Этап 7: Формирование ответа ✅

- [x] Создать шаблон ответа пользователю
- [x] Форматировать список источников (до 3 ссылок)
- [x] Показывать оценку уверенности
- [x] Обработка случаев когда источники не найдены

## Этап 8: Деплой на Vercel

- [ ] Настроить проект на Vercel
- [ ] Добавить переменные окружения в Vercel
- [ ] Задеплоить проект
- [ ] Зарегистрировать webhook в Telegram:
  ```powershell
  Invoke-RestMethod -Uri "https://api.telegram.org/bot<TOKEN>/setWebhook?url=https://<APP>.vercel.app/api/webhook"
  ```

## Этап 9: Тестирование и отладка

- [ ] Тестирование с различными типами входных данных
- [ ] Обработка ошибок и edge-cases
- [ ] Логирование для отладки
- [ ] Оптимизация времени ответа

---

## Структура проекта

```
FindOrigin/
├── app/
│   ├── api/
│   │   └── webhook/
│   │       └── route.ts        # Telegram webhook handler
│   ├── layout.tsx
│   └── page.tsx
├── lib/
│   ├── telegram.ts             # Telegram API утилиты
│   ├── parser.ts               # Парсинг текста и ссылок
│   ├── search.ts               # Google Search API
│   └── ai.ts                   # OpenAI GPT-4o-mini
├── types/
│   └── index.ts                # TypeScript типы
├── bot.js                      # Локальный бот (polling)
├── .env.local                  # Переменные окружения
├── PROJECT.md                  # Спецификация
├── PLAN.md                     # План реализации
└── package.json
```

## Переменные окружения

| Переменная | Описание | Обязательно |
|------------|----------|-------------|
| `BOT_TOKEN` | Токен от @BotFather | Да |
| `OPENAI_API_KEY` | Ключ OpenAI для GPT-4o-mini | Да |
| `GOOGLE_API_KEY` | Ключ Google Custom Search API | Нет* |
| `GOOGLE_SEARCH_ENGINE_ID` | ID поискового движка Google | Нет* |

*Без Google ключей используется DuckDuckGo

## Зависимости

```json
{
  "dependencies": {
    "next": "^14.2.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "openai": "^4.28.0"
  }
}
```
